package Pb11;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import AOC.AOC;
import Pb11.Pb11_1.Singe;

public class Pb11 extends AOC 
{
	static Singe[] singes = new Singe[8];
	static int nbRounds;
	static int nbSinges;
	static int round = 0;
	static boolean test = false;
	
	public static void main(String[] args) throws IOException 
	{
		String donnees = chargerDonnees("pb 11.txt");
		
		//test
//		donnees = "Monkey 0:\n"
//				+ "  Starting items: 79, 98\n"
//				+ "  Operation: new = old * 19\n"
//				+ "  Test: divisible by 23\n"
//				+ "    If true: throw to monkey 2\n"
//				+ "    If false: throw to monkey 3\n"
//				+ "\n"
//				+ "Monkey 1:\n"
//				+ "  Starting items: 54, 65, 75, 74\n"
//				+ "  Operation: new = old + 6\n"
//				+ "  Test: divisible by 19\n"
//				+ "    If true: throw to monkey 2\n"
//				+ "    If false: throw to monkey 0\n"
//				+ "\n"
//				+ "Monkey 2:\n"
//				+ "  Starting items: 79, 60, 97\n"
//				+ "  Operation: new = old * old\n"
//				+ "  Test: divisible by 13\n"
//				+ "    If true: throw to monkey 1\n"
//				+ "    If false: throw to monkey 3\n"
//				+ "\n"
//				+ "Monkey 3:\n"
//				+ "  Starting items: 74\n"
//				+ "  Operation: new = old + 3\n"
//				+ "  Test: divisible by 17\n"
//				+ "    If true: throw to monkey 0\n"
//				+ "    If false: throw to monkey 1";
//		test = true;
//		nbSinges = 4; 
		
		String[] notes = donnees.split("\n\n");
		for(String s : notes)
		{
			int n = Integer.parseInt(s.substring(7,8));
			singes[n] = new Singe(s);
			if (test) System.out.println(singes[n]);
		}
		
		//première partie
		System.out.println(partie_1());
		//Deuxième partie
		System.out.println(partie_2());
		

		
	}

	private static String partie_2() 
	{
		nbRounds = 10000;
		
		return null;
	}

	private static int partie_1() 
	{
		nbRounds = 20;

		while (round < nbRounds)
		{
			round++;
			for(int n = 0; n < nbSinges; n++)
			{
				traiter(singes[n]);
			}
		}
		int max1 = 1, max2 = 0;
		for(int i = 0; i < nbSinges; i++)
		{
			int n = singes[i].getTotalInspection();
			System.out.println("Singe " + i + "\t" + n);
			if (n > max1)
			{
				max2 = max1;
				max1 = n;
			}
			else if (n > max2) max2 = n;
		}
		
		return max1*max2;
	}

	private static void traiter(Singe singe) 
	{
		for(int i = 0; i < singe.getWorryLevel().size(); i++)
		{
			singe.incrementeTotalInspection();
			Long worryLevel = singe.getWorryLevel().get(i);
			int[] dest = singe.getDestinataires();
			String operation = singe.getOperation();
			char operateur = operation.charAt(0);
			int operande = -1;
			String s = operation.substring(2);
			if (operation.equals("* old")) operateur = '²';
			else operande = Integer.parseInt(s);
			switch (operateur)
			{
				case '²' :
					worryLevel = worryLevel * worryLevel;
					worryLevel = worryLevel / 3;
					if (modulo(worryLevel, singe.getDivisible()) == 0) 
						singes[dest[0]].ajouteWorryLevel(worryLevel);
					else
						singes[dest[1]].ajouteWorryLevel(worryLevel);
					break;
					
				case '+' :
					worryLevel = worryLevel + operande;
					worryLevel = worryLevel / 3;
					if (worryLevel % singe.getDivisible() == 0) 
						singes[dest[0]].ajouteWorryLevel(worryLevel);
					else
						singes[dest[1]].ajouteWorryLevel(worryLevel);
					break;
					
				case '*' :
					worryLevel = worryLevel * operande;
					worryLevel = worryLevel / 3;
					if (worryLevel % singe.getDivisible() == 0) 
						singes[dest[0]].ajouteWorryLevel(worryLevel);
					else
						singes[dest[1]].ajouteWorryLevel(worryLevel);
					break;
				default :
					 throw new RuntimeException("Cas non, traité " + operation);
			}
		}
		singe.videWorryLevel();	
	}

	private static int modulo(Long worryLevel, int D) 
	{
		if (worryLevel < 1000000) return (int) (worryLevel % D);
		
		long x = (long) Math.sqrt(worryLevel);
		int r = modulo(x,D);
		long n = worryLevel - x*x;
		return modulo(r*r + n, D); 
	}
	
	private static void afficherWL() 
	{
		for(int i = 0; i < nbSinges; i++)
		{
			String s = "Monkey " + i + "\t" + "";
			for(Long t : singes[i].getWorryLevel())
			{
				s += t + ", ";
			}
			System.out.println(s);
		}
	}

	static class Singe
	{
		int numero;
		List<Long> worryLevel = new ArrayList<Long>();
		int divisible;
		int[] destinataires = new int[2];
		int totalInspection = 0;

		String operation;
		
		public Singe(String s) 
		{
			String[] donnees = s.split("\n");
			//numero
			numero = Integer.parseInt(s.substring(7,8));
			
			//liste des items
			String liste = donnees[1].substring(18);
			String[] listeItems = liste.split(", ");
			for(String item : listeItems)
			{
				worryLevel.add((long) Integer.parseInt(item));
			}
			
			//operation
			operation = donnees[2].substring(23);
			
			//test
			divisible = Integer.parseInt(donnees[3].substring(21));
			
			//destinataires
			destinataires[0] = Integer.parseInt(donnees[4].substring(29));
			destinataires[1] = Integer.parseInt(donnees[5].substring(30));
		}

		public void incrementeTotalInspection() 
		{
			totalInspection++;
			
		}

		public void videWorryLevel() 
		{
			worryLevel.clear();
		}

		public void ajouteWorryLevel(long wl) 
		{
			worryLevel.add(wl);
		}

		public int[] getDestinataires() {
			return destinataires;
		}

		public void setDestinataires(int[] destinataires) {
			this.destinataires = destinataires;
		}

		public int getDivisible() {
			return divisible;
		}

		public void setDivisible(int divisible) {
			this.divisible = divisible;
		}
		public int getNumero() {
			return numero;
		}

		public void setNumero(int numero) {
			this.numero = numero;
		}

		public List<Long> getWorryLevel() {
			return worryLevel;
		}

		public void setWorryLevel(List<Long> worryLevel) {
			this.worryLevel = worryLevel;
		}

		public String getOperation() {
			return operation;
		}

		public void setOperation(String operation) {
			this.operation = operation;
		}
		
		public int getTotalInspection() {
			return totalInspection;
		}

		public void setTotalInspection(int totalInspection) {
			this.totalInspection = totalInspection;
		}

		public String toString()
		{
			String s = "Monkey " + numero + ":";
			
			s += "\n  Starting items:";
			String t = "";
			for(Long i : worryLevel) t += ", " + i;
			if (! t.isEmpty()) t= t.substring(1); 
			s += t; 
			s += "\n  Operation: new = old " + operation;
			
			s += "\n  Test: divisible by " + divisible;
			
			s += "\n    If true: throw to Monkey " + destinataires[0];
			s += "\n    If false: throw to Monkey " + destinataires[1];
			
			return s + "\n";
		}
	}
	
}
